trigger:
  branches:
    include:
      - main

variables:
  # Configure these as pipeline variables or in a Variable Group in Azure DevOps
  - name: AGENT_YAML_PATH
    value: 'agents/simple-agent.yaml'
  - name: FOUNDRY_ENDPOINT
    value: 'https://adusa-poc-agent.services.ai.azure.com/api/projects/adusa-poc-agent'
  - name: AZURE_SERVICE_CONNECTION
    value: 'ado-service-connection'

stages:

- stage: Validate
  displayName: Validate and publish agent
  jobs:
  - job: PublishAgent
    pool: 'egen-agent-pool'
    steps:
    - checkout: self
    
    - bash: |
        python3 --version
        which python3
      displayName: 'Check Python version'
    
    - task: AzureCLI@2
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          python3 -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # az cli automatically sets up auth context
          # Now run the deployment script which will use az cli credentials via DefaultAzureCredential
          .venv/bin/python -m scripts.deploy_agent "$(FOUNDRY_ENDPOINT)" "$(AGENT_YAML_PATH)"
      displayName: 'Install dependencies and deploy agent'
